#!/usr/bin/env node
const program = require('commander');
const Twit = require('twit');
const mongoose = require('mongoose');
const conf = require('../lib/config');
//const UserTimeline = require('../lib/UserTimeline');
//const makeTimelineModel = require('../lib/models/timeline.js');
const App = require('../lib/app');


program
  .option('-u, --user [screen_name]', 'Screen Name of the user to get tweets.')
  .option('-t, --tweets [tweets]', 'How much tweets get.')
  .option('-c, --collection [collection]', 'Collection name for mongodb.')
  .parse(process.argv);

let colName;
let count;

if (!program.user) {
  console.error('username is required.');
  process.exit(1);
}

if (!program.collection) {
  colName = conf.get('mongodb.collection');
} else {
  colName = program.collection;
}

if (!program.tweets) {
  count = 200;
} else {
  count = parseInt(program.tweets, 10);
}

mongoose.connect(`${conf.get('mongodb.url')}`, { useNewUrlParser: true })
  .then(() => console.log('Now connected to MongoDB!'))
  .then(() => {
    const app = new App();
    const T = new Twit(conf.get('twitter'));
    app.setTimeline(T, colName);
    app.run(program.user, count).then(
      () => { console.log('Finish...'); }
    ).then(() => process.exit());
  }).catch(err => {
    console.error('Something went wrong', err);
    process.exit(1);
  });


